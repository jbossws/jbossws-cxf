<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ JBoss, Home of Professional Open Source.
  ~ Copyright 2014, Red Hat, Inc., and individual contributors
  ~ as indicated by the @author tags. See the copyright.txt file in the
  ~ distribution for a full listing of individual contributors.
  ~
  ~ This is free software; you can redistribute it and/or modify it
  ~ under the terms of the GNU Lesser General Public License as
  ~ published by the Free Software Foundation; either version 2.1 of
  ~ the License, or (at your option) any later version.
  ~
  ~ This software is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  ~ Lesser General Public License for more details.
  ~
  ~ You should have received a copy of the GNU Lesser General Public
  ~ License along with this software; if not, write to the Free
  ~ Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
  ~ 02110-1301 USA, or see the FSF site: http://www.fsf.org.
  -->

<project basedir="." default="deploy">

  <property name="output.dir" value="${basedir}/target/output"/>
  <property name="deploy.artifacts.dir" value="${basedir}/target/assembly/deploy-artifacts"/>
  <property name="jbossws.default.modules.conf" value="${basedir}/target/assembly/deploy-artifacts/modules-deploy.conf"/>
	
  <target name="deploy" depends="prepare,deploy-wildfly821-if-available,deploy-wildfly900-if-available,deploy-wildfly1000-if-available" description="Deploy jbossws to wildfly"/>

  <target name="deploy-wildfly821-if-available" if="wildfly821.available">
  	<antcall target="deploy-wildfly821"/>
  </target>

  <target name="deploy-wildfly900-if-available" if="wildfly900.available">
  	<antcall target="deploy-wildfly900"/>
  </target>
	
  <target name="deploy-wildfly1000-if-available" if="wildfly1000.available">
  	<antcall target="deploy-wildfly1000"/>
  </target>

  <target name="prepare">
    <condition property="wildfly821.home" value="${jboss.home}">
      <equals arg1="${jbossws.integration.target}" arg2="wildfly821"/>
    </condition>
    <condition property="wildfly900.home" value="${jboss.home}">
      <equals arg1="${jbossws.integration.target}" arg2="wildfly900"/>
    </condition>
    <condition property="wildfly1000.home" value="${jboss.home}">
      <equals arg1="${jbossws.integration.target}" arg2="wildfly1000"/>
    </condition>
    <property name="wildfly821.available.file" value="${wildfly821.home}/jboss-modules.jar"/>
    <property name="wildfly900.available.file" value="${wildfly900.home}/jboss-modules.jar"/>
    <property name="wildfly1000.available.file" value="${wildfly1000.home}/jboss-modules.jar"/>
    <available property="wildfly821.available" file="${wildfly821.available.file}"/>   
    <available property="wildfly900.available" file="${wildfly900.available.file}"/>   
    <available property="wildfly1000.available" file="${wildfly1000.available.file}"/>   
    <tstamp>
      <format property="build.id" pattern="yyyyMMddHHmm"/>
    </tstamp>
  </target>
	
  <target name="init" depends="prepare">
          
    <fail message="jbossws.integration.target not set" unless="jbossws.integration.target"/>
    <echo message="integration.target=${jbossws.integration.target}"/>
    
    <property name="deploy.structure" value="${output.dir}/deploy-${jbossws.integration.target}"/>
  </target>

  <!-- ================================================================== -->
  <!-- Prepare Deployment Structure WildFly-8.0.x                         -->
  <!-- ================================================================== -->

  <target name="deploy-structure-wildfly80x" depends="init">
    <delete dir="${deploy.structure}"/>

    <path id="jboss.ant.tasks.classpath">
      <fileset dir="${deploy.artifacts.dir}">
        <include name="**/jbossws-common-tools.jar"/>
        <include name="**/jandex.jar"/>
      </fileset>
    </path>
    <taskdef name="installModules" classname="org.jboss.ws.tools.ant.InstallModulesTask" classpathref="jboss.ant.tasks.classpath"/>
    <taskdef name="jandex" classname="org.jboss.jandex.JandexAntTask" classpathref="jboss.ant.tasks.classpath"/>

    <jandex run="true" verbose="false" newJar="true">
      <fileset dir="${deploy.artifacts.dir}/lib">
        <include name="cxf*security.jar"/>
      </fileset>
    </jandex>
    <antcall target="deploy-jbossws-cxf-modules-as8" inheritall="false">
      <param name="installserver" value="${deploy.structure}/modules/system/layers/base"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="jbossid" value="${jbossws.integration.target}"/>
      <param name="modules-jbossid" value="wildfly800"/>
    </antcall>
  	<copy toDir="${deploy.structure}/modules/system/layers/base">
      <fileset dir="${deploy.artifacts.dir}/modules/wildfly800">
        <include name="**/jboss/as/webservices/main/module.xml"/>
      	<include name="**/jboss/as/webservices/server/integration/main/module.xml"/>
      </fileset>
    </copy>
  </target>

  <!-- ================================================================== -->
  <!-- Deployment wildfly821                                              -->
  <!-- ================================================================== -->

  <target name="target-wildfly821">
    <property name="jbossws.integration.target" value="wildfly821"/>
    <echo message="jbossws.integration.target=${jbossws.integration.target}"/>
  </target>

  <target name="deploy-wildfly821" depends="undeploy-wildfly821,deploy-structure-wildfly80x,check-spring,install-spring-module80x">
    <fail message="Not available: ${wildfly821.available.file}" unless="wildfly821.available"/>
    <copy todir="${wildfly821.home}" overwrite="true" verbose="true">
      <fileset dir="${deploy.structure}">
        <exclude name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </copy>
    <!-- Install org/jboss/as/webservices module.xml separately since it needs to reference libs already on the AS -->
    <installModules targetDir="${wildfly821.home}/modules/system/layers/base/">
      <fileset dir="${deploy.structure}/modules/system/layers/base">
        <include name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </installModules>
  </target>

  <target name="undeploy-wildfly821" depends="target-wildfly821,init">
    <fail message="Not available: ${wildfly821.available.file}" unless="wildfly821.available"/>
    <macro-undeploy-jbossws-modules targetdir="${wildfly821.home}/modules/system/layers/base" defaultmodulesconf="${jbossws.default.modules.conf}" modifyjbossintegration="true"/>
  </target>

  <!-- ================================================================== -->
  <!-- Prepare Deployment Structure WildFly-9.0.x                         -->
  <!-- ================================================================== -->

  <target name="deploy-structure-wildfly90x" depends="init">
    <delete dir="${deploy.structure}"/>
    <path id="jboss.ant.tasks.classpath">
      <fileset dir="${deploy.artifacts.dir}">
        <include name="**/jbossws-common-tools.jar"/>
        <include name="**/jandex.jar"/>
      </fileset>
    </path>
    <taskdef name="installModules" classname="org.jboss.ws.tools.ant.InstallModulesTask" classpathref="jboss.ant.tasks.classpath"/>
    <taskdef name="jandex" classname="org.jboss.jandex.JandexAntTask" classpathref="jboss.ant.tasks.classpath"/>
    <jandex run="true" verbose="false" newJar="true">
      <fileset dir="${deploy.artifacts.dir}/lib">
        <include name="cxf*security.jar"/>
      </fileset>
    </jandex>
    <antcall target="deploy-jbossws-cxf-modules-as9" inheritall="false">
      <param name="installserver" value="${deploy.structure}/modules/system/layers/base"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="jbossid" value="${jbossws.integration.target}"/>
      <param name="modules-jbossid" value="wildfly900"/>
    </antcall>
  	<copy toDir="${deploy.structure}/modules/system/layers/base">
      <fileset dir="${deploy.artifacts.dir}/modules/wildfly900">
        <include name="**/jboss/as/webservices/main/module.xml"/>
      	<include name="**/jboss/as/webservices/server/integration/main/module.xml"/>
      </fileset>
    </copy>
  </target>

  <!-- ================================================================== -->
  <!-- Deployment wildfly900                                              -->
  <!-- ================================================================== -->

  <target name="target-wildfly900">
    <property name="jbossws.integration.target" value="wildfly900"/>
    <echo message="jbossws.integration.target=${jbossws.integration.target}"/>
  </target>
  <target name="deploy-wildfly900" depends="undeploy-wildfly900,deploy-structure-wildfly90x,check-spring,install-spring-module90x">
    <fail message="Not available: ${wildfly900.available.file}" unless="wildfly900.available"/>
    <copy todir="${wildfly900.home}" overwrite="true" verbose="true">
      <fileset dir="${deploy.structure}">
        <exclude name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </copy>
    <!-- Install org/jboss/as/webservices module.xml separately since it needs to reference libs already on the AS -->
    <installModules targetDir="${wildfly900.home}/modules/system/layers/base/">
      <fileset dir="${deploy.structure}/modules/system/layers/base">
        <include name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </installModules>
  </target>

  <target name="undeploy-wildfly900" depends="target-wildfly900,init">
    <fail message="Not available: ${wildfly900.available.file}" unless="wildfly900.available"/>
    <macro-undeploy-jbossws-modules targetdir="${wildfly900.home}/modules/system/layers/base" defaultmodulesconf="${jbossws.default.modules.conf}" modifyjbossintegration="true"/>
  </target>

  <!-- ================================================================== -->
  <!-- Prepare Deployment Structure WildFly-10.0.x                        -->
  <!-- ================================================================== -->

  <target name="deploy-structure-wildfly100x" depends="init">
    <delete dir="${deploy.structure}"/>
    <path id="jboss.ant.tasks.classpath">
      <fileset dir="${deploy.artifacts.dir}">
        <include name="**/jbossws-common-tools.jar"/>
        <include name="**/jandex.jar"/>
      </fileset>
    </path>
    <taskdef name="installModules" classname="org.jboss.ws.tools.ant.InstallModulesTask" classpathref="jboss.ant.tasks.classpath"/>
    <taskdef name="jandex" classname="org.jboss.jandex.JandexAntTask" classpathref="jboss.ant.tasks.classpath"/>
    <jandex run="true" verbose="false" newJar="true">
      <fileset dir="${deploy.artifacts.dir}/lib">
        <include name="cxf*security.jar"/>
      </fileset>
    </jandex>
    <antcall target="deploy-jbossws-cxf-modules-as10" inheritall="false">
      <param name="installserver" value="${deploy.structure}/modules/system/layers/base"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="jbossid" value="${jbossws.integration.target}"/>
      <param name="modules-jbossid" value="wildfly1000"/>
    </antcall>
  	<copy toDir="${deploy.structure}/modules/system/layers/base">
      <fileset dir="${deploy.artifacts.dir}/modules/wildfly1000">
        <include name="**/jboss/as/webservices/main/module.xml"/>
      	<include name="**/jboss/as/webservices/server/integration/main/module.xml"/>
      </fileset>
    </copy>
  </target>

  <!-- ================================================================== -->
  <!-- Deployment wildfly1000                                             -->
  <!-- ================================================================== -->

  <target name="target-wildfly1000">
    <property name="jbossws.integration.target" value="wildfly1000"/>
    <echo message="jbossws.integration.target=${jbossws.integration.target}"/>
  </target>
  <target name="deploy-wildfly1000" depends="undeploy-wildfly1000,deploy-structure-wildfly100x,check-spring,install-spring-module100x">
    <fail message="Not available: ${wildfly1000.available.file}" unless="wildfly1000.available"/>
    <copy todir="${wildfly1000.home}" overwrite="true" verbose="true">
      <fileset dir="${deploy.structure}">
        <exclude name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </copy>
    <!-- Install org/jboss/as/webservices module.xml separately since it needs to reference libs already on the AS -->
    <installModules targetDir="${wildfly1000.home}/modules/system/layers/base/">
      <fileset dir="${deploy.structure}/modules/system/layers/base">
        <include name="**/jboss/as/webservices/**/module.xml"/>
      </fileset>
    </installModules>
  </target>

  <target name="undeploy-wildfly1000" depends="target-wildfly1000,init">
    <fail message="Not available: ${wildfly1000.available.file}" unless="wildfly1000.available"/>
    <macro-undeploy-jbossws-modules targetdir="${wildfly1000.home}/modules/system/layers/base" defaultmodulesconf="${jbossws.default.modules.conf}" modifyjbossintegration="false"/>
  </target>

  <!-- ================================================================== -->
  <!-- Spring                                                             -->
  <!-- ================================================================== -->
  <target name="check-spring">
    <condition property="spring-required">
      <and>
        <istrue value="${spring}"/>
      </and>
    </condition>
  </target>

  <target name="install-spring-module80x" if="spring-required">
    <antcall target="deploy-spring-module" inheritall="false">
      <param name="installserver" value="${deploy.structure}/modules/system/layers/base"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="modules-jbossid" value="wildfly800"/>
    </antcall>
  </target>

  <target name="install-spring-module90x" if="spring-required">
    <antcall target="deploy-spring-module" inheritall="false">
      <param name="installserver" value="${deploy.structure}/modules/system/layers/base"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="modules-jbossid" value="wildfly900"/>
    </antcall>
  </target>
	
  <target name="install-spring-module100x" if="spring-required">
    <antcall target="deploy-spring-module" inheritall="false">
      <param name="installserver" value="${deploy.structure}/modules/system/layers/base"/>
      <param name="thirdpartydir" value="${deploy.artifacts.dir}"/>
      <param name="modules-jbossid" value="wildfly1000"/>
    </antcall>
  </target>
	
  <!-- ================================================================== -->
  <!-- ================================================================== -->
  <!-- ||                          M A C R O s                         || -->
  <!-- ================================================================== -->
  <!-- ================================================================== -->


  <!-- ================================================================== -->
  <!-- Modules                                                            -->
  <!-- ================================================================== -->

  <macrodef name="macro-deploy-jbossws-modules-as9">
    <attribute name="thirdpartydir"/>
    <attribute name="targetdir"/>
    <attribute name="jbossid"/>
    <attribute name="modules-jbossid"/>
    <sequential>
      <!-- libraries -->
      <copy todir="@{targetdir}/org/jboss/ws/jaxws-client/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-client.jar"/>
          <include name="**/jbossws-cxf-jaspi.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/jaxws-undertow-httpspi/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jaxws-undertow-httpspi.jar"/>
        </fileset>
     </copy>
     <copy todir="@{targetdir}/org/jboss/ws/cxf/jbossws-cxf-server/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-server.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/cxf/jbossws-cxf-factories/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-factories.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/cxf/jbossws-cxf-transports-undertow/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-transports-undertow.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/cxf/jbossws-cxf-transports-udp/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-transports-udp.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/cxf/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/cxf-core*.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/cxf/impl/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/cxf-*.jar"/>
          <exclude name="**/cxf-core*.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/api/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-api.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/common/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-common.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/tools/common/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-common-tools.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/spi/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-spi.jar"/>
        </fileset>
       </copy>
      <copy todir="@{targetdir}/org/apache/httpcomponents/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">       
          <include name="**/httpcore.jar"/>
          <include name="**/httpcore-nio.jar"/>
          <include name="**/httpasyncclient.jar"/>
          <include name="**/httpclient.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/neethi/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/neethi.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/santuario/xmlsec/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/xmlsec.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/ws/security/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/wss4j-*.jar"/>
          <include name="**/jasypt.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/ws/xmlschema/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/xmlschema-core.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/opensaml/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/opensaml.jar"/>
          <include name="**/openws.jar"/>
          <include name="**/xmltooling.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/as/webservices/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-resources-@{jbossid}.jar"/>
          <include name="**/jbossws-@{jbossid}-server-integration.jar"/>
        </fileset>
      </copy>
      <!-- module.xml files -->
      <installModules targetDir="@{targetdir}">
        <fileset dir="@{thirdpartydir}/modules/@{modules-jbossid}">
          <include name="**/module.xml"/>
          <exclude name="**/jboss/as/webservices/**/module.xml"/>
          <exclude name="**/spring/**/module.xml"/>
        </fileset>
      </installModules>
    </sequential>
  </macrodef>

  <macrodef name="macro-deploy-jbossws-modules-as8">
    <attribute name="thirdpartydir"/>
    <attribute name="targetdir"/>
    <attribute name="jbossid"/>
    <attribute name="modules-jbossid"/>
    <sequential>
      <!-- libraries -->
      <copy todir="@{targetdir}/org/jboss/ws/jaxws-client/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-client.jar"/>
          <include name="**/jbossws-cxf-jaspi.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/jaxws-undertow-httpspi/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jaxws-undertow-httpspi.jar"/>
        </fileset>
     </copy>
     <copy todir="@{targetdir}/org/jboss/ws/cxf/jbossws-cxf-server/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-server.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/cxf/jbossws-cxf-factories/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-factories.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/cxf/jbossws-cxf-transports-undertow/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-transports-undertow.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/cxf/jbossws-cxf-transports-udp/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-transports-udp.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/cxf/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/cxf-core*.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/cxf/impl/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/cxf-*.jar"/>
          <exclude name="**/cxf-core*.jar"/>      
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/api/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-api.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/common/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-common.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/tools/common/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-common-tools.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/ws/spi/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-spi.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/httpcomponents/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">       
          <include name="**/httpcore.jar"/>
          <include name="**/httpcore-nio.jar"/>
          <include name="**/httpasyncclient.jar"/>
          <include name="**/httpclient.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/neethi/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/neethi.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/santuario/xmlsec/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/xmlsec.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/ws/security/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/wss4j-*.jar"/>
          <include name="**/jasypt.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/apache/ws/xmlschema/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/xmlschema-core.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/opensaml/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/opensaml.jar"/>
          <include name="**/openws.jar"/>
          <include name="**/xmltooling.jar"/>
        </fileset>
      </copy>
      <copy todir="@{targetdir}/org/jboss/as/webservices/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/jbossws-cxf-resources-@{jbossid}.jar"/>
          <include name="**/jbossws-@{jbossid}-server-integration.jar"/>
        </fileset>
      </copy>
      <!-- module.xml files -->
      <installModules targetDir="@{targetdir}">
        <fileset dir="@{thirdpartydir}/modules/@{modules-jbossid}">
          <include name="**/module.xml"/>
          <exclude name="**/jboss/as/webservices/**/module.xml"/>
          <exclude name="**/spring/**/module.xml"/>
        </fileset>
      </installModules>
    </sequential>
  </macrodef>

  <!-- ================================================================== -->
  <!-- Deploy JBossWS                                                     -->
  <!-- ================================================================== -->

  <target name="check-parameters">
    <fail message="installserver must be specified" unless="installserver"/>
    <fail message="artifactsdir must be specified" unless="artifactsdir"/>
    <fail message="thirdpartydir must be specified" unless="thirdpartydir"/>
    <fail message="modifyjbossintegration must be specified" unless="modifyjbossintegration"/>
  </target>

  <target name="deploy-jbossws-cxf-modules-as8">
    <fail message="installserver must be specified" unless="installserver"/>
    <fail message="thirdpartydir must be specified" unless="thirdpartydir"/>
    <macro-deploy-jbossws-modules-as8 targetdir="${installserver}" thirdpartydir="${thirdpartydir}" jbossid="${jbossid}" modules-jbossid="${modules-jbossid}"/>
  </target>

  <target name="deploy-jbossws-cxf-modules-as9">
    <fail message="installserver must be specified" unless="installserver"/>
    <fail message="thirdpartydir must be specified" unless="thirdpartydir"/>
    <macro-deploy-jbossws-modules-as9 targetdir="${installserver}" thirdpartydir="${thirdpartydir}" jbossid="${jbossid}" modules-jbossid="${modules-jbossid}"/>
  </target>

  <target name="deploy-jbossws-cxf-modules-as10">
    <fail message="installserver must be specified" unless="installserver"/>
    <fail message="thirdpartydir must be specified" unless="thirdpartydir"/>
    <macro-deploy-jbossws-modules-as9 targetdir="${installserver}" thirdpartydir="${thirdpartydir}" jbossid="${jbossid}" modules-jbossid="${modules-jbossid}"/>
  </target>

  <!-- ================================================================== -->
  <!-- Install Spring                                                     -->
  <!-- ================================================================== -->
  
  <macrodef name="macro-install-spring-modules">
    <attribute name="thirdpartydir"/>
    <attribute name="targetdir"/>
  	<attribute name="modules-jbossid"/>
    <sequential>
      <!-- libraries -->
      <copy todir="@{targetdir}/org/springframework/spring/main" flatten="false" overwrite="true">
        <fileset dir="@{thirdpartydir}/lib">
          <include name="**/spring-*.jar"/>
        </fileset>
      </copy>
      <!-- module.xml files -->
      <installModules targetDir="@{targetdir}">
        <fileset dir="@{thirdpartydir}/modules/@{modules-jbossid}">
          <include name="**/spring/**/module.xml"/>
        </fileset>
      </installModules>
    </sequential>
  </macrodef>

  <target name="deploy-spring-module">
  	<fail message="installserver must be specified" unless="installserver"/>
    <fail message="thirdpartydir must be specified" unless="thirdpartydir"/>
  	<macro-install-spring-modules targetdir="${installserver}" thirdpartydir="${thirdpartydir}" modules-jbossid="${modules-jbossid}"/>
  </target>

  <!-- ================================================================== -->
  <!-- Undeploy JBossWS                                                   -->
  <!-- ================================================================== -->

  <macrodef name="macro-undeploy-jbossws-modules">
    <attribute name="defaultmodulesconf"/>
    <attribute name="targetdir"/>
  	<attribute name="modifyjbossintegration"/>
  	
    <sequential>
      <loadfile property="jbossws.modules.conf" srcfile="@{targetdir}/org/jboss/as/webservices/jbossws-modules.conf" failonerror="false"/>
      <loadfile property="jbossws.modules.conf" srcfile="@{defaultmodulesconf}" failonerror="false"/>

      <delete includeemptydirs="true" verbose="true">
        <fileset dir="@{targetdir}">
          <include name="**/org/jboss/as/webservices/main/jbossws-*-resources*"/>
          <include name="**/org/jboss/as/webservices/main/jbossws-jboss*"/>
        </fileset>
      </delete>
      <property name="jboss.modules" value="@{targetdir}"/>
      <antcall target="remove-jboss-integration-module">
        <param name="modifyjbossintegration" value="@{modifyjbossintegration}"/>
      </antcall>

      <!-- delete content of last deployment -->
      <delete includeemptydirs="true" verbose="true">
        <fileset dir="@{targetdir}" includes="${jbossws.modules.conf}"/>
      </delete>
    </sequential>
  </macrodef>

  <target name="remove-jboss-integration-module" depends="process-jboss-integration" if="fixintegration">
    <delete verbose="true">
      <fileset dir="${jboss.modules}">
        <include name="**/org/jboss/as/webservices/main/jboss-as-webservices-server-integration*"/>
        <include name="**/org/jboss/as/webservices/main/wildfly-webservices-server-integration*"/>
      </fileset>
    </delete>
  </target>
		
  <target name="process-jboss-integration">
    <condition property="fixintegration">
      <and>
        <istrue value="${modifyjbossintegration}"/>
      </and>
    </condition>
  </target>

</project>
